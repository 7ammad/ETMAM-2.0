# Phase 1.3 — Authentication: Patterns & Gotchas

> Generated by Claude Code skill stack (nextjs, supabase-postgres-best-practices, react-hook-form-zod, error-handling-patterns).
> Read this alongside IMPLEMENTATION.md Phase 1.3 and BACKEND.md.

---

## GOTCHAS (Read First)

### G1: Server Actions must use the SERVER Supabase client
```typescript
// ❌ WRONG — browser client in Server Action
import { createClient } from '@/lib/supabase/client'

// ✅ CORRECT — server client
import { createClient } from '@/lib/supabase/server'
```
The server client at `src/lib/supabase/server.ts` uses `cookies()` from `next/headers` (async in Next.js 16). The browser client at `src/lib/supabase/client.ts` uses `createBrowserClient` — only for Client Components.

### G2: Use `redirect()` not `router.push()` in Server Actions
```typescript
// ❌ WRONG — router.push is client-only
import { useRouter } from 'next/navigation'

// ✅ CORRECT — redirect() works in Server Actions
import { redirect } from 'next/navigation'
```
`redirect()` throws a special Next.js error that must NOT be caught in try/catch. Place it OUTSIDE the try block.

### G3: redirect() must be called OUTSIDE try/catch
```typescript
// ❌ WRONG — redirect gets caught by catch block
export async function login(formData: FormData) {
  try {
    // ...auth logic...
    redirect('/dashboard') // This throws, gets caught below!
  } catch (error) {
    return { error: 'Login failed' } // redirect is swallowed
  }
}

// ✅ CORRECT — redirect after try/catch
export async function login(formData: FormData) {
  let shouldRedirect = false
  try {
    // ...auth logic...
    shouldRedirect = true
  } catch (error) {
    return { error: 'فشل تسجيل الدخول' }
  }
  if (shouldRedirect) {
    redirect('/dashboard')
  }
}
```

### G4: proxy.ts already exists and works — DON'T rewrite it
The existing `src/proxy.ts` already handles:
- Protected routes → redirect to `/login`
- Auth routes (login/register) → redirect authenticated users to `/dashboard`
- Session refresh via `updateSession()` from `src/lib/supabase/middleware.ts`

Phase 1.3 task 4 says "Wire up proxy" — this means **verify it works**, not rewrite it.

### G5: useAuth() hook already exists — reuse it
`src/hooks/use-auth.ts` already provides `{ user, loading, signOut }`. The Header component should use this hook, not create its own auth state.

### G6: Profile auto-creation is handled by DB trigger
The migration in `supabase/migrations/20260206120000_initial_schema.sql` has a trigger that auto-creates a `profiles` row when a user registers via `auth.users`. The Server Action does NOT need to manually insert into profiles.

### G7: Next.js 16 — cookies() is async
```typescript
// ❌ WRONG (Next.js 15 pattern)
const cookieStore = cookies()

// ✅ CORRECT (Next.js 16)
const cookieStore = await cookies()
```
The existing `src/lib/supabase/server.ts` already handles this correctly.

### G8: Zod v4 + @hookform/resolvers compatibility
There's a known issue with Zod v4 and @hookform/resolvers ([#813](https://github.com/react-hook-form/resolvers/issues/813)). If TypeScript errors occur, use `import { z } from 'zod/v3'` as fallback or check if @hookform/resolvers@5.2.2+ resolves it. The project has zod@4.3.6.

**Workaround if needed:** Skip zodResolver and validate manually in the Server Action with `schema.safeParse()`.

---

## Pattern 1: Server Action for Auth (`app/actions/auth.ts`)

```typescript
'use server'

import { createClient } from '@/lib/supabase/server'
import { redirect } from 'next/navigation'

// Return type for form state
type AuthResult = {
  error?: string
}

export async function login(formData: FormData): Promise<AuthResult> {
  const email = formData.get('email') as string
  const password = formData.get('password') as string

  // Server-side validation
  if (!email || !password) {
    return { error: 'البريد الإلكتروني وكلمة المرور مطلوبان' }
  }

  const supabase = await createClient()

  const { error } = await supabase.auth.signInWithPassword({
    email,
    password,
  })

  if (error) {
    // Map Supabase errors to Arabic user-facing messages
    if (error.message.includes('Invalid login credentials')) {
      return { error: 'بيانات الدخول غير صحيحة' }
    }
    return { error: 'حدث خطأ أثناء تسجيل الدخول' }
  }

  // redirect MUST be outside try/catch (see G3)
  redirect('/dashboard')
}

export async function register(formData: FormData): Promise<AuthResult> {
  const email = formData.get('email') as string
  const password = formData.get('password') as string
  const fullName = formData.get('fullName') as string

  if (!email || !password || !fullName) {
    return { error: 'جميع الحقول مطلوبة' }
  }

  if (password.length < 6) {
    return { error: 'كلمة المرور يجب أن تكون 6 أحرف على الأقل' }
  }

  const supabase = await createClient()

  const { error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      data: {
        full_name: fullName,
      },
    },
  })

  if (error) {
    if (error.message.includes('already registered')) {
      return { error: 'البريد الإلكتروني مسجل بالفعل' }
    }
    return { error: 'حدث خطأ أثناء إنشاء الحساب' }
  }

  redirect('/dashboard')
}

export async function logout(): Promise<void> {
  const supabase = await createClient()
  await supabase.auth.signOut()
  redirect('/login')
}
```

**Key points:**
- `createClient()` is async (Next.js 16 cookies)
- `redirect()` is OUTSIDE try/catch
- Error messages are in Arabic
- Profile creation is automatic via DB trigger (G6)
- `options.data.full_name` passes to the DB trigger for profile creation

---

## Pattern 2: LoginForm Component (`components/auth/LoginForm.tsx`)

```typescript
'use client'

import { useActionState } from 'react'
import { login } from '@/app/actions/auth'
import Link from 'next/link'

export function LoginForm() {
  const [state, formAction, isPending] = useActionState(login, { error: undefined })

  return (
    <form action={formAction} className="w-full max-w-sm space-y-4">
      <div className="space-y-2">
        <label htmlFor="email" className="block text-sm font-medium text-foreground">
          البريد الإلكتروني
        </label>
        <input
          id="email"
          name="email"
          type="email"
          required
          autoComplete="email"
          dir="ltr"
          className="w-full rounded-md border border-border bg-input px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground focus:border-border-focus focus:outline-none focus:ring-1 focus:ring-ring"
          placeholder="you@example.com"
        />
      </div>

      <div className="space-y-2">
        <label htmlFor="password" className="block text-sm font-medium text-foreground">
          كلمة المرور
        </label>
        <input
          id="password"
          name="password"
          type="password"
          required
          autoComplete="current-password"
          dir="ltr"
          className="w-full rounded-md border border-border bg-input px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground focus:border-border-focus focus:outline-none focus:ring-1 focus:ring-ring"
        />
      </div>

      {state?.error && (
        <div role="alert" className="rounded-md bg-destructive/10 p-3 text-sm text-destructive">
          {state.error}
        </div>
      )}

      <button
        type="submit"
        disabled={isPending}
        className="w-full rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-gold-600 disabled:opacity-50 transition-colors"
      >
        {isPending ? 'جارٍ تسجيل الدخول...' : 'تسجيل الدخول'}
      </button>

      <p className="text-center text-sm text-muted-foreground">
        ليس لديك حساب؟{' '}
        <Link href="/register" className="text-gold-500 hover:underline">
          إنشاء حساب
        </Link>
      </p>
    </form>
  )
}
```

**Key points:**
- Uses `useActionState` (React 19) — NOT `useFormState` (deprecated)
- `isPending` provides loading state natively
- Email/password inputs use `dir="ltr"` for LTR text in RTL layout
- Error display uses `role="alert"` for accessibility
- Uses design tokens from globals.css (bg-primary, text-foreground, etc.)
- NO useEffect, NO useState needed — `useActionState` handles everything

---

## Pattern 3: RegisterForm Component (`components/auth/RegisterForm.tsx`)

Same pattern as LoginForm but with additional fields:
- `fullName` (text input, Arabic label: "الاسم الكامل")
- `confirmPassword` field (validate match client-side for UX, server validates too)

```typescript
// Confirm password validation (client-side for UX only)
// Server Action validates independently (see Pattern 1)
const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {
  const form = e.currentTarget
  const password = form.password.value
  const confirm = form.confirmPassword.value
  if (password !== confirm) {
    e.preventDefault()
    setLocalError('كلمات المرور غير متطابقة')
    return
  }
}
```

---

## Pattern 4: Header with User Menu (`components/layout/Header.tsx`)

```typescript
'use client'

import { useAuth } from '@/hooks/use-auth'
import { logout } from '@/app/actions/auth'

export function Header() {
  const { user, loading } = useAuth()

  return (
    <header className="sticky top-0 z-10 border-b border-border bg-card px-6 py-3">
      <div className="flex items-center justify-between">
        <span className="text-sm text-muted-foreground">إتمام — نظام إدارة المنافسات</span>
        <div className="flex items-center gap-3">
          {loading ? (
            <div className="h-4 w-24 animate-pulse rounded bg-muted" />
          ) : user ? (
            <>
              <span className="text-sm text-foreground">
                {user.user_metadata?.full_name || user.email}
              </span>
              <form action={logout}>
                <button
                  type="submit"
                  className="rounded-md px-3 py-1 text-sm text-muted-foreground hover:text-foreground hover:bg-muted transition-colors"
                >
                  تسجيل الخروج
                </button>
              </form>
            </>
          ) : null}
        </div>
      </div>
    </header>
  )
}
```

**Key points:**
- Reuses existing `useAuth()` hook (G5)
- Logout uses `<form action={logout}>` — Server Action pattern
- Shows user's full_name from metadata, fallback to email
- Loading skeleton while auth state resolves

---

## Pattern 5: Login/Register Page Structure

The existing login/register pages at `src/app/(auth)/login/page.tsx` and `register/page.tsx` are bare stubs. Replace with:

```typescript
// app/(auth)/login/page.tsx
import { LoginForm } from '@/components/auth/LoginForm'

export default function LoginPage() {
  return (
    <main className="flex min-h-screen items-center justify-center bg-background p-4">
      <div className="w-full max-w-sm space-y-6">
        <div className="text-center">
          <h1 className="text-2xl font-bold text-gold-500">إتمام</h1>
          <p className="mt-2 text-sm text-muted-foreground">
            نظام إدارة المنافسات الذكي
          </p>
        </div>
        <LoginForm />
      </div>
    </main>
  )
}
```

---

## Pattern 6: Dashboard Layout Integration

The existing dashboard layout at `src/app/(dashboard)/layout.tsx` has a placeholder comment:
```
{/* User menu placeholder — Phase 1.3 Auth */}
```

Replace with the Header component:
```typescript
import { Header } from '@/components/layout/Header'
// ... then use <Header /> instead of the inline header markup
```

The sidebar nav stays as-is. Only the header section changes.

---

## Existing Code to Reuse (DO NOT recreate)

| File | What it provides | Reuse how |
|------|-----------------|-----------|
| `src/proxy.ts` | Route protection (login redirect, auth redirect) | Verify it works — don't rewrite |
| `src/lib/supabase/server.ts` | `createClient()` for Server Actions | Import in auth actions |
| `src/lib/supabase/client.ts` | `createClient()` for Client Components | Used by useAuth hook |
| `src/lib/supabase/middleware.ts` | `updateSession()` for proxy | Already wired in proxy.ts |
| `src/hooks/use-auth.ts` | `{ user, loading, signOut }` | Use in Header component |
| `src/app/globals.css` | All design tokens (colors, fonts, shadows) | Use Tailwind classes |
| `src/lib/design-tokens.ts` | JS-accessible design tokens | For programmatic use only |

---

## Files to Create

1. `src/app/actions/auth.ts` — Server Actions (login, register, logout)
2. `src/components/auth/LoginForm.tsx` — Login form component
3. `src/components/auth/RegisterForm.tsx` — Register form component
4. `src/components/layout/Header.tsx` — Header with user + logout

## Files to Modify

1. `src/app/(auth)/login/page.tsx` — Replace stub with LoginForm
2. `src/app/(auth)/register/page.tsx` — Replace stub with RegisterForm
3. `src/app/(dashboard)/layout.tsx` — Replace header placeholder with Header component

---

## Arabic Error Messages Reference

| Scenario | Arabic Message |
|----------|---------------|
| Required fields | جميع الحقول مطلوبة |
| Invalid credentials | بيانات الدخول غير صحيحة |
| Email already registered | البريد الإلكتروني مسجل بالفعل |
| Password too short | كلمة المرور يجب أن تكون 6 أحرف على الأقل |
| Passwords don't match | كلمات المرور غير متطابقة |
| Login failed (generic) | حدث خطأ أثناء تسجيل الدخول |
| Register failed (generic) | حدث خطأ أثناء إنشاء الحساب |
| Logging in... | جارٍ تسجيل الدخول... |
| Creating account... | جارٍ إنشاء الحساب... |
| Email label | البريد الإلكتروني |
| Password label | كلمة المرور |
| Full name label | الاسم الكامل |
| Confirm password label | تأكيد كلمة المرور |
| Login button | تسجيل الدخول |
| Register button | إنشاء حساب |
| No account? | ليس لديك حساب؟ |
| Have account? | لديك حساب بالفعل؟ |
| Logout | تسجيل الخروج |

---

## Acceptance Test Checklist (from IMPLEMENTATION.md)

After implementation, verify:
- [ ] Can register a new account
- [ ] Can login with registered account
- [ ] Redirected to /dashboard after login
- [ ] Can logout → redirected to /login
- [ ] Visiting /dashboard without auth → redirected to /login
- [ ] Profile auto-created in profiles table
