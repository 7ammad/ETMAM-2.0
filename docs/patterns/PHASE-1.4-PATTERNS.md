# Phase 1.4 â€” Tender Upload & List: Patterns & Gotchas

> Generated by Claude Code skill stack (nextjs, supabase-postgres-best-practices, typescript-advanced-types, react-hook-form-zod).
> Read this alongside IMPLEMENTATION.md Phase 1.4, BACKEND.md, and FRONTEND.md.

---

## GOTCHAS (Read First)

### G1: Database Field Name Mismatch â€” `entity` NOT `entity_name`

**CRITICAL**: The database table uses `entity` but IMPLEMENTATION.md mentions `entity_name` in validation. Use `entity`.

```typescript
// âŒ WRONG â€” from IMPLEMENTATION.md typo
const schema = z.object({
  entity_name: z.string()  // âŒ Database column is 'entity'
})

// âœ… CORRECT â€” matches BACKEND.md schema
const schema = z.object({
  entity: z.string()  // âœ… Matches tenders table
})
```

The CSV parser at [csv-parser.ts:9](src/lib/utils/csv-parser.ts#L9) correctly uses `entity`. Match this everywhere.

---

### G2: Tender Field Names Don't Match CSV Parser

**ParsedTender** interface uses different names than the database:

| CSV Parser | Database Column | Fix Needed |
|------------|----------------|------------|
| `tender_title` | `tender_title` | âœ… OK |
| `tender_number` | `tender_number` | âœ… OK |
| `entity` | `entity` | âœ… OK |
| `deadline` | `deadline` | âœ… OK |
| `estimated_value` | `estimated_value` | âœ… OK |
| `description` | `description` | âœ… OK |
| `requirements` | `requirements` | âŒ String in parser, JSONB in DB |

**Solution**: Transform `requirements` from string â†’ JSONB array before save:

```typescript
// In Server Action before insert
const requirements = parsedTender.requirements
  ? parsedTender.requirements.split('\n').filter(r => r.trim())
  : []

const dbTender = {
  ...parsedTender,
  requirements: requirements, // Will be JSONB in DB
  user_id: user.id,
  source_type: 'csv' as const,
  // Add required fields from BACKEND.md
}
```

---

### G3: File Upload in Next.js 16 â€” Use FormData, NOT useActionState for Files

File uploads don't work with `useActionState` because File objects aren't serializable. Use form action directly.

```typescript
// âŒ WRONG â€” useActionState can't handle File
const [state, formAction] = useActionState(uploadAction, null)
<input type="file" />

// âœ… CORRECT â€” Direct form submission with FormData
async function handleSubmit(e: React.FormEvent<HTMLFormElement>) {
  e.preventDefault()
  const formData = new FormData(e.currentTarget)
  const file = formData.get('file') as File

  // Client-side parsing (PapaParse/XLSX)
  const text = await file.text()
  const parsed = parseCSV(text)

  // Then call Server Action with JSON data
  await uploadTenders(parsed.valid)
}
```

**Pattern**: Parse file on client â†’ send parsed JSON to Server Action (not raw file).

---

### G4: CSV Parsing Must Handle Arabic Numbers

Arabic users may use Arabic-Indic digits (`Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©`) or Arabic thousands separators (`ØŒ`).

```typescript
// âŒ WRONG â€” Doesn't handle Arabic formats
const value = parseFloat(row['Ù‚ÙŠÙ…Ø© ØªÙ‚Ø¯ÙŠØ±ÙŠØ©'])

// âœ… CORRECT â€” Normalize before parsing (already in csv-parser.ts:68)
const num = parseFloat(value.replace(/[,ØŒ]/g, ''))
```

The existing [csv-parser.ts:68](src/lib/utils/csv-parser.ts#L68) handles this. Don't rewrite it.

---

### G5: Deadline Field â€” String Date Format vs ISO

CSV may have dates like `"2026-02-15"` or `"15/02/2026"`. Database needs DATE type (ISO string).

```typescript
// Zod schema with transform
z.string().transform((val) => {
  // Try multiple formats
  const date = new Date(val)
  if (isNaN(date.getTime())) {
    // Try DD/MM/YYYY format
    const parts = val.split('/')
    if (parts.length === 3) {
      const [day, month, year] = parts
      return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`
    }
    throw new Error('Invalid date format')
  }
  return date.toISOString().split('T')[0] // YYYY-MM-DD
})
```

---

### G6: Bulk Insert with RLS â€” Use Service Role Key or Batch Single Inserts

RLS policies require `user_id` match. Bulk inserts can fail if not using service role key.

```typescript
// âŒ WRONG â€” RLS will block if user_id not set correctly
const { data } = await supabase.from('tenders').insert(tenders)

// âœ… CORRECT Option 1 â€” Set user_id explicitly for each tender
const tendersWithUser = parsedTenders.map(t => ({
  ...t,
  user_id: user.id,
  source_type: 'csv',
  created_at: new Date().toISOString(),
}))
const { data, error } = await supabase.from('tenders').insert(tendersWithUser)

// âœ… CORRECT Option 2 â€” Use service role key for batch (bypass RLS)
// Only if you're sure about auth context
```

**Best Practice**: Always add `user_id` explicitly before insert. Never rely on DB defaults for auth-dependent fields.

---

### G7: Table Component Must Use Logical Properties for RTL

Sortable table headers with arrows need to flip in RTL mode.

```typescript
// âŒ WRONG â€” Arrow always points right
<th className="text-left">
  Title <span className="ml-1">â†’</span>
</th>

// âœ… CORRECT â€” Use logical properties and flip arrow
<th className="text-start">
  Title <span className="ms-1">{sortOrder === 'asc' ? 'â†‘' : 'â†“'}</span>
</th>
```

All spacing/alignment: use `start`/`end` not `left`/`right`. Use `ps-`/`pe-`/`ms-`/`me-` not `pl-`/`pr-`/`ml-`/`mr-`.

---

### G8: Empty State Must Be Informative, Not Just "No Data"

```typescript
// âŒ WRONG â€” Not helpful
<div>No tenders found</div>

// âœ… CORRECT â€” Actionable empty state
<EmptyState
  icon={<DocumentIcon />}
  title="Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ÙØ³Ø§Øª"
  description="Ø§Ø¨Ø¯Ø£ Ø¨Ø±ÙØ¹ Ù…Ù„Ù CSV Ø£Ùˆ Excel ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§ÙØ³Ø§Øª"
  action={
    <Button onClick={() => router.push('/tenders/upload')}>
      Ø±ÙØ¹ Ù…Ù†Ø§ÙØ³Ø§Øª
    </Button>
  }
/>
```

---

## Pattern 1: File Upload Component (Client-Side Parsing)

```typescript
// components/tender/TenderUpload.tsx
'use client'

import { useState } from 'react'
import { parseCSV, parseExcel, type ParsedTender } from '@/lib/utils/csv-parser'
import { uploadTenders } from '@/app/actions/tenders'

export function TenderUpload() {
  const [file, setFile] = useState<File | null>(null)
  const [preview, setPreview] = useState<ParsedTender[]>([])
  const [errors, setErrors] = useState<{ row: number; message: string }[]>([])
  const [uploading, setUploading] = useState(false)

  async function handleFileChange(e: React.ChangeEvent<HTMLInputElement>) {
    const selectedFile = e.target.files?.[0]
    if (!selectedFile) return

    setFile(selectedFile)
    setErrors([])
    setPreview([])

    try {
      const ext = selectedFile.name.split('.').pop()?.toLowerCase()

      if (ext === 'csv') {
        const text = await selectedFile.text()
        const result = parseCSV(text)
        setPreview(result.valid)
        setErrors(result.errors)
      } else if (ext === 'xlsx' || ext === 'xls') {
        const buffer = await selectedFile.arrayBuffer()
        const result = parseExcel(buffer)
        setPreview(result.valid)
        setErrors(result.errors)
      } else {
        setErrors([{ row: 0, message: 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ø³ØªØ®Ø¯Ù… CSV Ø£Ùˆ Excel' }])
      }
    } catch (error) {
      setErrors([{ row: 0, message: 'ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ' + (error as Error).message }])
    }
  }

  async function handleUpload() {
    if (preview.length === 0) return

    setUploading(true)
    try {
      const result = await uploadTenders(preview)

      if (result.success) {
        // Show success toast
        alert(`ØªÙ… Ø±ÙØ¹ ${result.created} Ù…Ù†Ø§ÙØ³Ø© Ø¨Ù†Ø¬Ø§Ø­`)
        // Reset form
        setFile(null)
        setPreview([])
        setErrors([])
      } else {
        setErrors([{ row: 0, message: result.error || 'ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹' }])
      }
    } catch (error) {
      setErrors([{ row: 0, message: 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±ÙØ¹' }])
    } finally {
      setUploading(false)
    }
  }

  return (
    <div className="space-y-6">
      {/* File Input */}
      <div className="border-2 border-dashed border-border rounded-lg p-8 text-center hover:border-gold-500 transition-colors">
        <input
          type="file"
          accept=".csv,.xlsx,.xls"
          onChange={handleFileChange}
          className="hidden"
          id="file-upload"
        />
        <label
          htmlFor="file-upload"
          className="cursor-pointer block"
        >
          <div className="text-muted-foreground mb-2">
            {file ? file.name : 'Ø§Ø³Ø­Ø¨ Ù…Ù„Ù CSV Ø£Ùˆ Excel Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±'}
          </div>
          <div className="text-sm text-muted-foreground">
            Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª
          </div>
        </label>
      </div>

      {/* Errors */}
      {errors.length > 0 && (
        <div className="bg-destructive/10 border border-destructive rounded-md p-4">
          <h3 className="font-semibold text-destructive mb-2">Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ù…Ù„Ù:</h3>
          <ul className="text-sm space-y-1">
            {errors.map((err, i) => (
              <li key={i}>
                ØµÙ {err.row}: {err.message}
              </li>
            ))}
          </ul>
        </div>
      )}

      {/* Preview Table */}
      {preview.length > 0 && (
        <div className="space-y-4">
          <h3 className="text-lg font-semibold">
            Ù…Ø¹Ø§ÙŠÙ†Ø© ({preview.length} Ù…Ù†Ø§ÙØ³Ø§Øª)
          </h3>
          <div className="border border-border rounded-lg overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-muted">
                <tr>
                  <th className="px-4 py-2 text-start">Ø§Ù„Ø¬Ù‡Ø©</th>
                  <th className="px-4 py-2 text-start">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</th>
                  <th className="px-4 py-2 text-start">Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø§ÙØ³Ø©</th>
                  <th className="px-4 py-2 text-start">Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
                  <th className="px-4 py-2 text-start">Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©</th>
                </tr>
              </thead>
              <tbody>
                {preview.slice(0, 5).map((tender, i) => (
                  <tr key={i} className="border-t border-border">
                    <td className="px-4 py-2">{tender.entity}</td>
                    <td className="px-4 py-2">{tender.tender_title}</td>
                    <td className="px-4 py-2">{tender.tender_number}</td>
                    <td className="px-4 py-2">{tender.deadline}</td>
                    <td className="px-4 py-2" dir="ltr">
                      {tender.estimated_value.toLocaleString('ar-SA')}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
            {preview.length > 5 && (
              <div className="px-4 py-2 text-sm text-muted-foreground bg-muted">
                + {preview.length - 5} Ù…Ù†Ø§ÙØ³Ø§Øª Ø£Ø®Ø±Ù‰
              </div>
            )}
          </div>

          <button
            onClick={handleUpload}
            disabled={uploading}
            className="w-full rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-gold-600 disabled:opacity-50 transition-colors"
          >
            {uploading ? 'Ø¬Ø§Ø±Ù Ø§Ù„Ø±ÙØ¹...' : `Ø±ÙØ¹ ${preview.length} Ù…Ù†Ø§ÙØ³Ø§Øª`}
          </button>
        </div>
      )}
    </div>
  )
}
```

**Key Points**:
- Client-side parsing (no Server Action for raw file)
- Shows preview before upload (first 5 rows)
- Validates and shows errors per row
- Only sends JSON to Server Action
- Uses Arabic labels and RTL layout
- Number formatting with `toLocaleString('ar-SA')`

---

## Pattern 2: Server Action for Bulk Insert

```typescript
// app/actions/tenders.ts
'use server'

import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { z } from 'zod'

// Match ParsedTender but with validation
const tenderInputSchema = z.object({
  entity: z.string().min(1, 'Ø§Ù„Ø¬Ù‡Ø© Ù…Ø·Ù„ÙˆØ¨Ø©'),
  tender_title: z.string().min(1, 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ù…Ø·Ù„ÙˆØ¨'),
  tender_number: z.string().min(1, 'Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ù…Ø·Ù„ÙˆØ¨'),
  deadline: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­Ø©'),
  estimated_value: z.number().positive('Ø§Ù„Ù‚ÙŠÙ…Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…ÙˆØ¬Ø¨Ø©'),
  description: z.string().optional(),
  requirements: z.string().optional(),
  tender_url: z.string().url().optional().or(z.literal('')),
})

type TenderInput = z.infer<typeof tenderInputSchema>

export async function uploadTenders(tenders: TenderInput[]) {
  const supabase = await createClient()

  // Get authenticated user
  const { data: { user }, error: authError } = await supabase.auth.getUser()
  if (authError || !user) {
    return { success: false, error: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' }
  }

  // Validate all tenders
  const validated: TenderInput[] = []
  for (const tender of tenders) {
    const result = tenderInputSchema.safeParse(tender)
    if (result.success) {
      validated.push(result.data)
    } else {
      // Could collect validation errors per tender
      console.error('Validation failed:', result.error)
    }
  }

  if (validated.length === 0) {
    return { success: false, error: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ÙØ³Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ù„Ø±ÙØ¹' }
  }

  // Transform for database
  const dbTenders = validated.map(tender => ({
    user_id: user.id,
    entity: tender.entity,
    tender_title: tender.tender_title,
    tender_number: tender.tender_number,
    deadline: tender.deadline,
    estimated_value: tender.estimated_value,
    description: tender.description,

    // Transform requirements: string â†’ JSONB array
    requirements: tender.requirements
      ? tender.requirements.split('\n').filter(r => r.trim())
      : [],

    // Source tracking
    source_type: 'csv' as const,
    source_file_name: null,
    source_file_path: null,

    // Default status
    status: 'new' as const,

    // JSONB fields
    line_items: [],
    extraction_warnings: [],
  }))

  // Bulk insert
  const { data, error } = await supabase
    .from('tenders')
    .insert(dbTenders)
    .select()

  if (error) {
    console.error('Insert error:', error)
    return { success: false, error: 'ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø§Øª: ' + error.message }
  }

  // Revalidate tenders list page
  revalidatePath('/tenders')

  return {
    success: true,
    created: data.length,
    tenders: data,
  }
}
```

**Key Points**:
- Validates with Zod before insert
- Adds `user_id` explicitly (RLS requirement)
- Transforms `requirements` string â†’ JSONB array
- Sets default values for all fields
- Uses `revalidatePath` to refresh tenders list
- Returns structured result for UI feedback

---

## Pattern 3: Tender List Page (Server Component â†’ Client Component)

```typescript
// app/(dashboard)/tenders/page.tsx (Server Component)
import { createClient } from '@/lib/supabase/server'
import { TenderListClient } from '@/components/tender/TenderListClient'

export default async function TendersPage() {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    // Proxy should catch this, but defensive check
    return null
  }

  // Fetch user's tenders
  const { data: tenders } = await supabase
    .from('tenders')
    .select('*')
    .eq('user_id', user.id)
    .order('created_at', { ascending: false })

  return (
    <div className="p-6">
      <div className="mb-6 flex items-center justify-between">
        <h1 className="text-2xl font-bold text-foreground">Ø§Ù„Ù…Ù†Ø§ÙØ³Ø§Øª</h1>
        <a
          href="/tenders/upload"
          className="rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-gold-600 transition-colors"
        >
          Ø±ÙØ¹ Ù…Ù†Ø§ÙØ³Ø§Øª
        </a>
      </div>

      <TenderListClient initialTenders={tenders ?? []} />
    </div>
  )
}
```

```typescript
// components/tender/TenderListClient.tsx (Client Component)
'use client'

import { useState } from 'react'
import type { Tender } from '@/types/database'

interface Props {
  initialTenders: Tender[]
}

export function TenderListClient({ initialTenders }: Props) {
  const [tenders, setTenders] = useState(initialTenders)
  const [sortBy, setSortBy] = useState<keyof Tender>('created_at')
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc')

  function handleSort(column: keyof Tender) {
    if (sortBy === column) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc')
    } else {
      setSortBy(column)
      setSortOrder('asc')
    }

    // Sort the tenders
    const sorted = [...tenders].sort((a, b) => {
      const aVal = a[column]
      const bVal = b[column]

      if (aVal == null) return 1
      if (bVal == null) return -1

      if (sortOrder === 'asc') {
        return aVal > bVal ? 1 : -1
      } else {
        return aVal < bVal ? 1 : -1
      }
    })

    setTenders(sorted)
  }

  if (tenders.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-12 text-center">
        <div className="mb-4 text-4xl">ğŸ“„</div>
        <h3 className="mb-2 text-lg font-semibold text-foreground">
          Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ÙØ³Ø§Øª
        </h3>
        <p className="mb-6 text-sm text-muted-foreground">
          Ø§Ø¨Ø¯Ø£ Ø¨Ø±ÙØ¹ Ù…Ù„Ù CSV Ø£Ùˆ Excel ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø§ÙØ³Ø§Øª
        </p>
        <a
          href="/tenders/upload"
          className="rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-gold-600 transition-colors"
        >
          Ø±ÙØ¹ Ù…Ù†Ø§ÙØ³Ø§Øª
        </a>
      </div>
    )
  }

  return (
    <div className="border border-border rounded-lg overflow-hidden">
      <table className="w-full text-sm">
        <thead className="bg-muted">
          <tr>
            <th
              className="px-4 py-3 text-start cursor-pointer hover:bg-muted/80"
              onClick={() => handleSort('entity')}
            >
              Ø§Ù„Ø¬Ù‡Ø© {sortBy === 'entity' && (sortOrder === 'asc' ? 'â†‘' : 'â†“')}
            </th>
            <th
              className="px-4 py-3 text-start cursor-pointer hover:bg-muted/80"
              onClick={() => handleSort('tender_title')}
            >
              Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© {sortBy === 'tender_title' && (sortOrder === 'asc' ? 'â†‘' : 'â†“')}
            </th>
            <th
              className="px-4 py-3 text-start cursor-pointer hover:bg-muted/80"
              onClick={() => handleSort('tender_number')}
            >
              Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© {sortBy === 'tender_number' && (sortOrder === 'asc' ? 'â†‘' : 'â†“')}
            </th>
            <th
              className="px-4 py-3 text-start cursor-pointer hover:bg-muted/80"
              onClick={() => handleSort('deadline')}
            >
              Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ {sortBy === 'deadline' && (sortOrder === 'asc' ? 'â†‘' : 'â†“')}
            </th>
            <th
              className="px-4 py-3 text-start cursor-pointer hover:bg-muted/80"
              onClick={() => handleSort('estimated_value')}
            >
              Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ© {sortBy === 'estimated_value' && (sortOrder === 'asc' ? 'â†‘' : 'â†“')}
            </th>
            <th className="px-4 py-3 text-start">Ø§Ù„Ø­Ø§Ù„Ø©</th>
          </tr>
        </thead>
        <tbody>
          {tenders.map((tender) => (
            <tr
              key={tender.id}
              className="border-t border-border hover:bg-muted/50 cursor-pointer transition-colors"
              onClick={() => window.location.href = `/tenders/${tender.id}`}
            >
              <td className="px-4 py-3">{tender.entity}</td>
              <td className="px-4 py-3">{tender.tender_title}</td>
              <td className="px-4 py-3">{tender.tender_number}</td>
              <td className="px-4 py-3">
                {new Date(tender.deadline).toLocaleDateString('ar-SA')}
              </td>
              <td className="px-4 py-3" dir="ltr">
                {tender.estimated_value.toLocaleString('ar-SA')}
              </td>
              <td className="px-4 py-3">
                <StatusBadge status={tender.status} />
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )
}

function StatusBadge({ status }: { status: string }) {
  const styles = {
    new: 'bg-gray-100 text-gray-800',
    evaluated: 'bg-purple-100 text-purple-800',
    costed: 'bg-blue-100 text-blue-800',
    exported: 'bg-green-100 text-green-800',
  }

  const labels = {
    new: 'Ø¬Ø¯ÙŠØ¯',
    evaluated: 'Ù…ÙÙ‚ÙŠÙ‘Ù…',
    costed: 'Ù…ÙÙƒÙ„Ù',
    exported: 'Ù…ÙØµØ¯Ù‘Ø±',
  }

  return (
    <span className={`inline-flex rounded-full px-2 py-1 text-xs font-semibold ${styles[status as keyof typeof styles]}`}>
      {labels[status as keyof typeof labels]}
    </span>
  )
}
```

**Key Points**:
- Server Component fetches data (no client-side fetch needed)
- Client Component handles interactivity (sort, click)
- Empty state with actionable CTA
- Sortable columns with arrow indicators
- Status badges with color coding
- Date/number formatting with Arabic locale
- Row click navigation to detail page

---

## Pattern 4: Type-Safe Database Types

```typescript
// Ensure generated types match actual schema
// After running: npx supabase gen types typescript --project-id <ref> > src/types/database.ts

// Import and use throughout the app
import type { Database } from '@/types/database'

export type Tender = Database['public']['Tables']['tenders']['Row']
export type TenderInsert = Database['public']['Tables']['tenders']['Insert']
export type TenderUpdate = Database['public']['Tables']['tenders']['Update']

// Type-safe Supabase queries
const { data } = await supabase
  .from('tenders')
  .select('*')
  .returns<Tender[]>()
```

---

## Arabic Error Messages Reference

| Scenario | Arabic Message |
|----------|---------------|
| Missing required field | Ø§Ù„Ø¬Ù‡Ø© Ù…Ø·Ù„ÙˆØ¨Ø© / Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ù…Ø·Ù„ÙˆØ¨ / Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø§ÙØ³Ø© Ù…Ø·Ù„ÙˆØ¨ |
| Invalid date format | ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ® ØºÙŠØ± ØµØ­ÙŠØ­Ø© |
| Invalid file type | Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø§Ø³ØªØ®Ø¯Ù… CSV Ø£Ùˆ Excel |
| File too large | Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª) |
| Parsing failed | ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù |
| Upload failed | ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù†Ø§ÙØ³Ø§Øª |
| No valid tenders | Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§ÙØ³Ø§Øª ØµØ§Ù„Ø­Ø© Ù„Ù„Ø±ÙØ¹ |
| Auth required | ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ |
| Upload success | ØªÙ… Ø±ÙØ¹ {count} Ù…Ù†Ø§ÙØ³Ø© Ø¨Ù†Ø¬Ø§Ø­ |

---

## Files to Create

1. `src/components/tender/TenderUpload.tsx` â€” File upload + preview component
2. `src/components/tender/TenderListClient.tsx` â€” Sortable table client component
3. `src/app/actions/tenders.ts` â€” Server Actions (uploadTenders, deleteTender, updateTender)
4. `src/app/(dashboard)/tenders/page.tsx` â€” Server Component for tender list
5. `src/app/(dashboard)/tenders/upload/page.tsx` â€” Upload page wrapper

## Files to Reuse (DO NOT recreate)

| File | What it provides | Reuse how |
|------|-----------------|-----------|
| `src/lib/utils/csv-parser.ts` | CSV/Excel parsing with Arabic column mapping | Import `parseCSV`, `parseExcel` |
| `src/lib/supabase/server.ts` | Server-side Supabase client | Use in Server Actions |
| `src/types/database.ts` | Generated database types | Import `Tender` type |

---

## Files to Modify

1. `src/app/(dashboard)/layout.tsx` â€” Ensure "Upload" link in sidebar navigation

---

## Acceptance Test Checklist (from IMPLEMENTATION.md)

After implementation, verify:
- [ ] Can upload a CSV file with tender data
- [ ] CSV is parsed and preview shown before saving
- [ ] Tenders appear in table after upload
- [ ] Invalid rows show error messages (Arabic)
- [ ] Table sorts by column headers (click to toggle asc/desc)
- [ ] Empty state shown when no tenders exist (with CTA button)
- [ ] Can click a tender row (navigates to `/tenders/[id]` even if detail page is empty)
- [ ] Numbers formatted with Arabic locale (`12,345.67` â†’ `Ù¡Ù¢Ù¬Ù£Ù¤Ù¥Ù«Ù¦Ù§`)
- [ ] Dates formatted with Arabic locale
- [ ] All labels in Arabic

---

## Performance Notes

- **Client-side parsing** (not Server Action for file) = faster, no 4.5MB body limit
- **Preview only first 5 rows** = avoid rendering 1000+ rows
- **Bulk insert** (not individual) = 1 DB round-trip for all tenders
- **No image uploads yet** = keep it simple for Phase 1.4

---

## Next Phase Dependencies

Phase 2.1 (AI Analysis) will:
- Read tenders from the `tenders` table
- Add `evaluation_score` and `recommendation` fields (already in schema)
- Use `tender_title`, `description`, `requirements` for AI input

Ensure these fields are populated correctly during Phase 1.4 upload.
